# 6장 안정적인 운영을 완성하는 모니터링, 프로메테우스와 그라파나

가장 권장하는 모니터링 도구는 프로메테우스와 그라파나다. 

## 6.1 컨테이너 인프라 환경 모니터링하기

bbytop은 현재 노드에 대한 정보를 보여줄 뿐, 다수의 노드로 구성된 클러스터 정보를 모두 표현하기 어렵다. 

이런 정보를 수집하고 분류해서 따로 저장해야 한다. 거의 모든 모니터링 도구는 **수집 → 통합 → 시각화** 구조로 되어 있다.

모니터링 데이터를 프로메테우스로 수집하고 수집한 정보를 한 곳에 모아, 그라파나로 시각화한다.

### 6.1.1 모니터링 도구 선택하기

프로메테우스와 그라파나의 혼합 구조는 크게 2가지다.

1. 비용
    1. 라이선스 비용, 클라우드 과금 비용 등을 생각하면 다른 선택지는 비용에 민감한 조직에선 도입이 어려움
2. 보안
    1. 서비스형 모니터링 도구들은 대부분 외부에 데이터를 저장해 모니터링한다.
    2. 보안에 민감해서 내부에서 모든 데이터를 처리하려는 경우 사용하기 어려움
    

이 책에서는 프로메테우스와 그라파나 혼합 구조로 진행한다.

그 외에도 사용하는 도구를 살펴보자.

**데이터 수집 도구**

- 프로메테우스(Prometheus): 사운드클라우드에서 자사 서비스 모니터링을 위해 개발한 도구다. 현재는 오픈 소스로 전환돼 CNCF에서 관리하며 2018년 8월 졸업 프로젝트가 됐다. 중앙 서버에서 에이전트의 데이터를 수집하는 pull 방식을 사용하므로 쿠버네티스 환경에서 설치된 에이전트를 통해 노드와 컨테이너 상태를 모두 수집해 모니터링할 수 있다. 그리고 에이전트를 통해 내부 메트릭을 외부로 노출하기 때문에 사용자가 수집 대상에 접속할 수 있다면 개인 컴퓨터에서도 메트릭을 가져올 수 있다.
- 데이터독(Datadog): 서비스형 소프트웨어(SaaS)로 웹사이트에서 모니터링 대상을 관리할 수 있고 다른 여러 클라우드 서비스와 연동이 쉽고 관리가 편하다. 단점은 모니터링 대상이 늘면 비용이 커진다.
- 뉴 렐릭(New Relic): SaaS, 데이터독에 비교하면 성능 모니터링(APM, Application Performace Monitoring)에 더 특화되어 있다.
- 인플럭스DB(InfluxDB): 오픈 소스, SaaS, 엔터프라이즈 버전 3가지 유형이 있다. 대량의 이벤트를 모니터링하는 데 좀 더 적합함. 분산 저장도 더 쉽게 구성할 수 있는 기능을 제공하기도 함(엔터프라이즈). 상대적으로 구성이 어려움

메트릭: 현재 시스템의 상태를 알 수 있는 측정값

시스템 메트릭: pod 같은 오브젝트에서 측정되는 CPU와 메모리 사용량을 나타내는 지표

서비스 메트릭: HTTP 상태 코드 같은 서비스 상태를 나타내는 지표

**데이터 시각화 도구**

- 그라파나: 그라파나 랩스 개발, 독립적인 시각화 도구. 주로 시계열 데이터 시각화에 많이 사용되나 RDBMS데이터를 표 형태로 시각화해 사용할 수도 있음, 설치형, 서비스형 둘 모두 존재
- 키바나(Kibana): 엘라스틱서치 개발한 엘라스틱에서 만든 시각화 도구. 엘라스틱서치의 데이터만을 시각화할 수 있기 때문에 프로메테우스의 시계열 데이터를 메트릭비트라는 도구로 엘라스틱서치에 전달해야하는 불편함이 있다. 하지만 시각화 기능이 굉장히 강력해서 시각화를 중점적으로 다룰 경우 사용하면 적합함
- 크로노그래프: 인플럭스DB 개발한 인플럭스 데이터에서 만든 시각화 도구. 오픈소스. 설치형, 서비스형 모두 존재. 키바나와 마찬가지로 인플럭스DB만 시각화할 수 있어 다양한 대상을 시각화할 수 없다.

### 6.1.2 쿠버네티스 환경에 적합한 모니터링 데이터 수집 방법

쿠버네티스 노드는 kubelet을 통해 pod를 관리하며, pod의 CPU나 메모리 같은 메트릭 정보를 수집하기 위해 kubelet에 내장된 cAdvisor를 사용한다. cAdvisor는 구글이 만든 컨테이너 메트릭 수집 도구로, 쿠버네티스 클러스터 위에 배포된 여러 컨테이너가 사용하는 메트릭 정보를 수집한 후 이를 가공해 kubelet에 전달하는 역할을 한다.

메트릭 데이터를 수집하는 목적으로 메트릭 서버를 설치해 HPA와 같은 기능을 구현하고 쿠버네티스 대시보드를 설치해 현재 상태를 확인할 수도 있다. 이렇게 메트릭 서버에서 수집한 데이터로 여러 기능을 수행하도록 구성한 것을 리소스 메트릭 파이프라인이라 한다.(Resource Matric Pipeline)

메트릭 서버는 집계한 데이터를 메모리에만 저장하므로 데이터를 영구적으로 보존하기 어렵고 현재 시점의 데이터만 출력된다. 그래서 메트릭 데이터를 저장 공간에 따로 저장하는 완전한 모니터링 파이프라인으로 구축하길 권장한다. 이 설계 방식을 반영한 도구가 프로메테우스다. 

프로메테우스는 여러 수집 대상이 공개하는 메트릭 데이터를 모아 시계열 데이터베이스에 저장한다. 저장된 데이터는 시간이 지나도 확인할 수 있는 영속적인 데이터다. 누적된 메트릭 데이터로는 쿠버네티스 인프라의 상태 변화를 파악할 수 있고, 적절한 위험 감지 및 조치를 취할 수 있다.

## 6.2 프로메테우스로 모니터링 데이터 수집과 통합하기

프로메테우스는 많은 종류의 오브젝트를 설치한다.

- 프로메테우스 서버(prometheus-server)
    - 공개된 메트릭을 수집해오는 수집기(service discovery 방식)
    - 수집한 시계열 메트릭 데이터를 저장하는 시계열 데이터베이스
    - 저장된 데이터를 질의하거나 수집 대상의 상태를 확인할 수 있는 웹 UI
- 노드 익스포터(node-exporter)
    - 메트릭 정보를 HTTP로 공개
    - 설치된 노드에서 특정 파일들을 읽고, 이를 프로테메우스 서버가 수집할 수 있는 메트릭 데이터로 변환한 후 노드 익스포터 HTTP 서버로 공개함
    - 공개된 내용을 프로메테우스 서버에서 수집해 가게 됨
- 쿠버 스테이트 메트릭(kube-state-metric)
    - API 서버로 쿠버네티스 클러스터의 여러 메트릭 데이터를 수집한 후, 이를 프로메테우스 서버가 수집할 수 있는 메트릭 데이터로 변환해 공개하는 역할을 함
    - 프로메테우스가 쿠버네티스 클러스터의 여러 정보를 손쉽게 획득할 수 있는 것은 모두 쿠버 스테이트 메트릭 덕분임
- 얼럿매니저(alertmanager)
    - 프로메테우스에 alert 규칙을 설정하고, 경보 이벤트가 발생하면 설정된 경보 메시지를 대상에게 전달하는 기능을 제공한다.
    - 프로메테우스에 설치하면 프로메테우스 서버에서 주기적으로 경보를 보낼 대상을 감시해 시스템을 안정적으로 운영할 수 있게 한다.
- 푸시게이트웨이(pushgateway)
    - 배치와 스케줄 작업 시 수행되는 일회성 작업들의 상태를 저장하고 모아서 프로메테우스가 주기적으로 가져갈 수 있도록 공개한다.
    

### 6.2.1 헬름으로 프로메테우스 설치하기

1. 사전 구성 - 헬름, MetalLB
2. 프로메테우스 차트 설치를 위해 프로메테우스 오브젝트 설치(프로메테우스 서버, 노드 익스포터, 쿠버 스테이트 메트릭)
    
    ```bash
    #!/usr/bin/env bash
    helm install prometheus edu/prometheus \ // 프로메테우스 차트를 사용해 프로메테우스 릴리스 설치
    --set pushgateway.enabled=false \ // 푸시게이트웨이 사용하지 않게 설정
    --set alertmanager.enabled=false \ // 얼럿매니저 사용하지 않게 설정
    --set nodeExporter.tolerations[0].key=node-role.kubernetes.io/master \ // 톨러레이션 설정
    --set nodeExporter.tolerations[0].effect=NoSchedule \ // 테인트 설정되 노드 설정 무시
    --set nodeExporter.tolerations[0].operator=Exists \
    --set server.persistentVolume.existingClaim="prometheus-server" \ // "promethus-server" pvc 사용하게 설정
    --set server.securityContext.runAsGroup=1000 \ // 사용자ID, 그룹ID 1000으로 설정
    --set server.securityContext.runAsUser=1000 \
    --set server.service.type="LoadBalancer" \ // MetalLB로부터 외부 IP 할당 받기 위해 로드밸런서로 설정
    --set server.extraFlags[0]="storage.tsdb.no-lockfile" // 프로메테우스 설정 변경 시 lockfile로 에러 날 수 있으니 생성되지 않게 설정
    ```
    
3. 확인
    
    ```bash
    kubectl get pods --selector=app=prometheus
    
    kubectl get service prometheus-server
    ```
    

### 6.2.2 프로메테우스의 웹 UI 다루기

1. 그래프(Graph)
    1. 쿼리 입력기: 표현식(Expression)을 입력해 프로메테우스가 적재한 메트릭 데이터 조회 가능. 이 때 사용하는 표현식은 PromQL이라는 프로메테우스에서 제공하는 쿼리 언어다.
    2. Execute: 쿼리 입력기에 입력한 PromQL을 실행하는 버튼.
    3. Graph: PromQL로 프로메테우스가 적재한 메트릭 데이터를 확인할 때 시각적으로 표현해주는 옵션.
    4. Console: 추출된 데이터를 보여주는 기본 옵션
    5. Add Graph: 쿼리 입력기를 추가함
    6. Remove Graph: 현재 쿼리 입력기 제거.
2. Alert : 서버에 등록된 경보 규칙과 경보 발생 여부를 확인할 수 있다.
3. Status 
    1. Runtime & Build Information : 프로메테우스 서버의 업타임 같은 런타임 관련 정보, 버전을 나타내는 빌드 정보 등 여러 정보를 확인할 수 있다.
    2. Command-Line Flags : 프로메테우스 서버가 실행될 때 인자로 입력 받았던 값을 보여 준다.
    3. Configuration : 프로메테우스 서버가 구동될 때 설정된 값을 표시함.
    4. Rules : 서버에 등록된 다양한 규칙 확인 가능.
    5. Targets : 프로메테우스 서버가 수집해오는 대상의 상태 확인.
    6. Service Discovery : 프로메테우스 서버가 서비스 디스커버리 방식으로 수집한 대상들에 대한 정보를 요약해 보여줌.



### 서비스 디스커버리로 수집 대상 가져오기

쿠버네티스는 서비스 디스커버리를 이용해 사용자가 에이전트에 추가로 입력할 필요 없이 자동으로 메트릭을 수집할 수 있다.

서비스 디스커버리 동작 순서

1. 프로메테우스 서버는 컨피그맵에 기록된 내용을 바탕으로 대상을 읽어옴
2. 읽어온 대상에 대한 메트릭을 가져오기 위해 API 서버에 정보를 요청함
3. 요청을 통해 알아온 경로로 메트릭 데이터를 수집함

프로메테우스 서버와 API 서버가 주기적으로 데이터를 주고받아 수집 대상을 업데이트하고, 수집 대상에서 공개되는 메트릭을 자동으로 수집한다.

cAdvisor와 익스포터 2가지 경로로 수집할 수 있다.

### cAdvisor

각 노드에 컨테이너 시스템 정보를 담고 있는 특정 파일들을 읽어 들여 메트릭을 수집한다.

그리고 프로메테우스가 수집할 수 있도록 컨테이너 메트릭을 프로메테우스의 메트릭으로 변환해 공개한다.

```bash
// 1. 프로메테우스 웹 ui에서 graph 메뉴의 쿼리 입력기에 container_memeory_usage_bytes를 입력하고 execute

// 출력된 결과 중 오른쪽 상단에 나온 3개의 내용은 다음과 같다.
// Load time: PromQL이 동작하는데 걸린 시간이다. 단위는 마이크로초다.
// Resolution: 수집된 데이터로 지정된 초 단위의 그래프를 그린다.
// Total time series: PromQL로 수집된 결과의 개수

// 2. PromQL문에 {container="nginx"}를 추가하고 다시 execute

// 3. 슈퍼푸티에서 디플로이먼트 배포
kubectl create deployment nginx --image=nginx

// 4. configmap 확인
kubectl get configmap prometheus-server -o yaml | nl
```

```yaml
56        job_name: kubernetes-nodes-cadvisor
57        kubernetes_sd_configs: # 쿠버네티스 서비스 디스커버리 구성 구문 시작
58        - role: node
59        relabel_configs: # 프로메테우스의 레이블 다시 정의
60        - action: labelmap # 레이블 변환하는 방식을 지정
61          regex: __meta_kubernetes_node_label_(.+) # 레이블 변환 부분을 탐색하는 조건식
62        - replacement: kubernetes.default.svc:443 # 설정된 레이블에 교체할 값
63          target_label: __address__ # 값을 교체할 레이블에 설정
64        - regex: (.+) # 원본 레이블에서 추출할 값을 지정하는 조건식
65          replacement: /api/v1/nodes/$1/proxy/metrics/cadvisor # 원본 레이블에서 추출한 값을 변수에 넣어 대상 레이블에 들어갈 값을 설정
66          source_labels: # 교체 대상이 되는 값이 있는 원본 레이블 지정
67          - __meta_kubernetes_node_name # 지정된 레이블을 교체 대상으로 설정
68          target_label: __metrics_path__ # 값을 교체할 레이블에 설정
```

### 익스포터

서비스 디스커버리에서 수집은 자동으로 이뤄지지만, 익스포터는 사전 준비 작업이 2가지 필요함.

- api 서버에 등록돼 경로를 알 수 있게 해야 하고.
- 익스포터가 데이터를 프로메테우스 타입으로 노출해야 한다.

익스포터에 필요한 사전 준비 작업을 진행하고, 노출된 메트릭을 확인해 보자.

```bash
// api 서버로 등록될 구성이 포함된 yaml 배포
kubectl apply -f ~/~~/nginx-status-annot.yaml

// 메트릭 수집을 위한 어노테이션 설정은 매니페스트에 적용돼 있음
cat ~/~~/nginx-status-annot.yaml | nl

// 웹 UI에서 Status > Targets을 선택

// nginx에서 제공하는 nginx-prometheus-exporter를 추가로 구성한 yaml 배포
kubectl apply -f ~/_Book_k8sInfra/ch6/6.2.3/nginx-status-metrics.yaml
```

> **멀티 컨테이너 패턴**
pod 내부에 컨테이너를 여러 개 구성하는 방법은 몇 가지가 있다.
> 
> - 사이드카(Sidecar) : 메인 컨테이너의 기능을 확장하거나 기능을 향상하고자 할 때 추가하는 패턴
> - 앰버서더(Ambassador) : 사용자가 외부에서 접근할 때 앰배서더 컨테이너를 통해 통신이 이루어지는 형태로, 세부적인 외부 접근 대상이나 방법은 앰배서더 컨테이너에 위임한다. 주로 프록시 컨테이너를 구성해 외부의 접근을 제어하고 내부 자원을 보호하는 구성이 앰배서더 패턴에 속함.
> - 어댑터(Adapter) : 메인 컨테이너의 정보를 외부에서 사용할 수 있는 형식으로 변환하는 컨테이너가 추가된 형태. 데이터 형태를 변환하므로 앞에서 다룬 NGINX의 익스포터는 어댑터 패턴에 해당한다.
> 
> 멀티 컨테이너 패턴은 한 가지 형태로 고정된 것이 아니라 형태를 해석하는 방식에 따라 한 가지 이상으로 부를 수 있다.

### 노드 익스포터로 쿠버네티스 노드 메트릭 수집하기

노드 익스포터는 쿠버네티스 노드의 상태 값을 메트릭으로 추출하는 데 특화돼 있다. 노드의 /proc과 /sys에 있는 값을 메트릭으로 노출하도록 구현돼 있다. 노드 익스포터를 실행하기 위해서 쿠버네티스 노드마다 1개씩 배포할 수 있는 데몬셋으로 구현돼 배포 된다.

1. /proc
    - 리눅스 운영 체제에서 구동 중인 프로세스들의 정보를 파일 시스템 형태로 연결한 디렉터리
    - 디렉터리 안에는 현재 구동 중인 프로세스들의 PID가 디렉터리 형태로 나타나며, 각 디렉터리 내부에 해당 프로세스에 대한 상태나 실행 환경에 대한 정보가 들어 있다.
    - 모니터링 도구는 이 디렉터리를 통해 시스템에서 구동 중인 프로세스의 정보나 상태, 자원 사용량 등을 알 수 있다.
2. sys
    - 저장 장치, 네트워크 장치, 입출력 장치 같은 각종 장치를 운영 체제에서 사용할 수 있도록 파일 시스템 형태로 연결한 디렉터리다.
    - 기존에 /proc에 연결돼 있던 커널 장치 드라이버 등이 /proc에서 /sys로 분리됐다.
    - 이 디렉터리 내부에 있는 파일들을 분석하면 전체 장치의 상태를 알 수 있기 때문에 모니터링 도구는 이 디텍터리를 시스템 장치의 상태 정보를 수집하는 데 사용함.

노드 익스포터는 각 쿠버네티스 노드의 /proc, /sys에 있는 파일들을 읽어서 프로메테우스가 받아들일 수 있는 메트릭 형태로 변환한다. 그리고 변환한 메트릭을 HTTP 서버를 통해 /metrics 주소로 공개 한다.

1. graph 메뉴에서 node_cpu_seconds_total을 입력하고 execute 누름
2. 누적된 CPU 상태 값을 봤으니 현재 상태에서 수집된 메트릭을 확인
    1. node_memory_MemAvailable_bytes를 입력하고 엔터 누름

### 쿠버 스테이트 메트릭으로 쿠버네티스 클러스터 메트릭 수집하기

쿠버네티스 상태에 관한 정보를 가지고 와서 프로메테우스가 받아들일 수 있는 메트릭 형태로 변환하고 변환한 메트릭을 HTTP 서버를 통해 /metrics 주소로 공개한다.
각 노드의 특정 디렉터리를 마운트해서 사용하지 않고 이미 API 서버에 모인 값들을 수집한다는 점이 노드 익스포터와 다르다.

1. 프로메테우스 쿼리 입력기에 `kube_pod_container_status_restarts_total`을 입력하고 Execute를 누릅니다.
2. 이번엔 쿠버네티스 현재 상태를 알아보는 메트릭을 검색
    - 쿼리 입력기에 `kube_service_created`를 입력하고 Execute 하면, 쿠버네티스에 존재하는 서비스들이 생성된 시간을 보여준다.
    - 이때 출력되는 시간은 유닉스 시간으로, 1970년 1월 1일 00:00:00 협정 세계시(UTC)부터의 경과 시간을 초로 환산해 정수로 나타낸 것




## 6.3 PromQL로 메트릭 데이터 추출하기

### 6.3.1 메트릭 데이터의 구조

웹 UI에서 쿼리 입력기에 up{job=”prometheus”} 를 입력

- up이 메트릭 이름
- job=”prometheus” 라는 레이블 이름을 검색 조건에 추가 (필터링)

### 메트릭 값의 종류

- 카운터(counter) : 누적된 값을 표현하는데 사용하는 메트릭 타입. 이벤트나 오류 등이 급증하는 구간을 파악하는데 적합함.
- 게이지(gauge) : 특정 시점의 값을 표현하는데 사용하는 메트릭 타입. 시점별로 증가나 감소를 모두 표현할 수 있다. CPU 온도나 메모리 사용량 등은 누적된 값이 필요하지 않고 조회하는 순간의 값이 중요하므로 게이지 타입을 사용한다.
- 히스토그램(histogram) : 사전에 미리 정의한 구간 안에 있는 메트릭 값의 빈도를 측정. 이 때 익스포터를 구현하는 단계에서 정의한 구간을 버킷이라고 한다.
- 서머리(summary) : 히스토그램과 비슷하게 구간 내에 있는 메트릭 값의 빈도를 측정하낟. 예를 들어, 클라이언트 요청에 따른 응답 시간을 관측하고 저장할 때 사용할 수 있다.

값이 tatal로 끝나면 카운터, bytes 나 created로 끝나면 게이지 타입이다.

### 메트릭 테이블

모든 메트릭 데이터는 하나 이상의 레이블을 갖는다. 프로메테우스의 레이블은 일반적인 주석이 아닌 메트릭 데이터의 다양한 내용을 표현하는 유일한 방법이다. 다수의 내용을 key-value 형태로 넣는다.

### 메트릭 레이블 매처

메트릭 테이블에 조건을 줘서 검색하는 방법을 레이블 매처라고 한다.(label matchers)

4가지의 조건 기호가 있다.

- = : 조건에 넣은 값과 레이블 값이 같은 메트릭을 보여준다.
- != : 조건과 같지 않은 메트릭을 보여줌
- =~ : 조건에 넣은 정규식에 해당하는 메트릭을 보여줌
- !~ : 조건에 넣은 정규식에 해당하지 않는 메트릭을 보여준다.

### 6.3.2 PromQL 연산자

- 비교연산자
- 논리연산자
- 산술연산자
- 집계연산자

여기는 SQL 처럼 필요한 부분은 검색해서 학습해 적용하는게 더 나을 듯함. 

기본적인 내용은 다른 개념과 비슷하다.

### 6.3.3 PromQL 데이터 타입

레인지 셀렉터(range selector) : 메트릭 데이터를 받아오는 구간, 설정하면 메트릭 값과 함께 시간 정보가 나타나 각 메트릭 값을 구분할 수 있다.

구간이 있는 PromQL 데이터 타입을 Range Vector라고 하고 특정 시점에 대한 메트릭 값만 가지는 PromQL 데이터 타입을 인스턴트 벡터(Instant Vector)라고 한다. 두 가지 타입 외에도 실수 값을 표현하는 스칼라 타입(Scala Type)과 문자열을 표현하는 스트링 타입(String Type)이 있다.

### 레인지 벡터와 인스턴스 벡터 비교하기

실습 생략

### 6.3.4 PromQL 함수

- 연산 함수
    - abs(절대값), ceil(올림), floor, round, predict_linear(예측값) 등
- 변환 함수
    - scalar(스칼라로 변환), vector(벡터로 변환), rate(변화율), irate(순간 변화율) 등
- 집계 함수
    - avg_over_time(평균), sum_over_time(합계), count_over_time(계수) 등