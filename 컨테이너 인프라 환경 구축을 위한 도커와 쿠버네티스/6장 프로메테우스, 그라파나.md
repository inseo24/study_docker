# 6장 안정적인 운영을 완성하는 모니터링, 프로메테우스와 그라파나

가장 권장하는 모니터링 도구는 프로메테우스와 그라파나다. 

## 6.1 컨테이너 인프라 환경 모니터링하기

bbytop은 현재 노드에 대한 정보를 보여줄 뿐, 다수의 노드로 구성된 클러스터 정보를 모두 표현하기 어렵다. 

이런 정보를 수집하고 분류해서 따로 저장해야 한다. 거의 모든 모니터링 도구는 **수집 → 통합 → 시각화** 구조로 되어 있다.

모니터링 데이터를 프로메테우스로 수집하고 수집한 정보를 한 곳에 모아, 그라파나로 시각화한다.

### 6.1.1 모니터링 도구 선택하기

프로메테우스와 그라파나의 혼합 구조는 크게 2가지다.

1. 비용
    1. 라이선스 비용, 클라우드 과금 비용 등을 생각하면 다른 선택지는 비용에 민감한 조직에선 도입이 어려움
2. 보안
    1. 서비스형 모니터링 도구들은 대부분 외부에 데이터를 저장해 모니터링한다.
    2. 보안에 민감해서 내부에서 모든 데이터를 처리하려는 경우 사용하기 어려움
    

이 책에서는 프로메테우스와 그라파나 혼합 구조로 진행한다.

그 외에도 사용하는 도구를 살펴보자.

**데이터 수집 도구**

- 프로메테우스(Prometheus): 사운드클라우드에서 자사 서비스 모니터링을 위해 개발한 도구다. 현재는 오픈 소스로 전환돼 CNCF에서 관리하며 2018년 8월 졸업 프로젝트가 됐다. 중앙 서버에서 에이전트의 데이터를 수집하는 pull 방식을 사용하므로 쿠버네티스 환경에서 설치된 에이전트를 통해 노드와 컨테이너 상태를 모두 수집해 모니터링할 수 있다. 그리고 에이전트를 통해 내부 메트릭을 외부로 노출하기 때문에 사용자가 수집 대상에 접속할 수 있다면 개인 컴퓨터에서도 메트릭을 가져올 수 있다.
- 데이터독(Datadog): 서비스형 소프트웨어(SaaS)로 웹사이트에서 모니터링 대상을 관리할 수 있고 다른 여러 클라우드 서비스와 연동이 쉽고 관리가 편하다. 단점은 모니터링 대상이 늘면 비용이 커진다.
- 뉴 렐릭(New Relic): SaaS, 데이터독에 비교하면 성능 모니터링(APM, Application Performace Monitoring)에 더 특화되어 있다.
- 인플럭스DB(InfluxDB): 오픈 소스, SaaS, 엔터프라이즈 버전 3가지 유형이 있다. 대량의 이벤트를 모니터링하는 데 좀 더 적합함. 분산 저장도 더 쉽게 구성할 수 있는 기능을 제공하기도 함(엔터프라이즈). 상대적으로 구성이 어려움

메트릭: 현재 시스템의 상태를 알 수 있는 측정값

시스템 메트릭: pod 같은 오브젝트에서 측정되는 CPU와 메모리 사용량을 나타내는 지표

서비스 메트릭: HTTP 상태 코드 같은 서비스 상태를 나타내는 지표

**데이터 시각화 도구**

- 그라파나: 그라파나 랩스 개발, 독립적인 시각화 도구. 주로 시계열 데이터 시각화에 많이 사용되나 RDBMS데이터를 표 형태로 시각화해 사용할 수도 있음, 설치형, 서비스형 둘 모두 존재
- 키바나(Kibana): 엘라스틱서치 개발한 엘라스틱에서 만든 시각화 도구. 엘라스틱서치의 데이터만을 시각화할 수 있기 때문에 프로메테우스의 시계열 데이터를 메트릭비트라는 도구로 엘라스틱서치에 전달해야하는 불편함이 있다. 하지만 시각화 기능이 굉장히 강력해서 시각화를 중점적으로 다룰 경우 사용하면 적합함
- 크로노그래프: 인플럭스DB 개발한 인플럭스 데이터에서 만든 시각화 도구. 오픈소스. 설치형, 서비스형 모두 존재. 키바나와 마찬가지로 인플럭스DB만 시각화할 수 있어 다양한 대상을 시각화할 수 없다.

### 6.1.2 쿠버네티스 환경에 적합한 모니터링 데이터 수집 방법

쿠버네티스 노드는 kubelet을 통해 pod를 관리하며, pod의 CPU나 메모리 같은 메트릭 정보를 수집하기 위해 kubelet에 내장된 cAdvisor를 사용한다. cAdvisor는 구글이 만든 컨테이너 메트릭 수집 도구로, 쿠버네티스 클러스터 위에 배포된 여러 컨테이너가 사용하는 메트릭 정보를 수집한 후 이를 가공해 kubelet에 전달하는 역할을 한다.

메트릭 데이터를 수집하는 목적으로 메트릭 서버를 설치해 HPA와 같은 기능을 구현하고 쿠버네티스 대시보드를 설치해 현재 상태를 확인할 수도 있다. 이렇게 메트릭 서버에서 수집한 데이터로 여러 기능을 수행하도록 구성한 것을 리소스 메트릭 파이프라인이라 한다.(Resource Matric Pipeline)

메트릭 서버는 집계한 데이터를 메모리에만 저장하므로 데이터를 영구적으로 보존하기 어렵고 현재 시점의 데이터만 출력된다. 그래서 메트릭 데이터를 저장 공간에 따로 저장하는 완전한 모니터링 파이프라인으로 구축하길 권장한다. 이 설계 방식을 반영한 도구가 프로메테우스다. 

프로메테우스는 여러 수집 대상이 공개하는 메트릭 데이터를 모아 시계열 데이터베이스에 저장한다. 저장된 데이터는 시간이 지나도 확인할 수 있는 영속적인 데이터다. 누적된 메트릭 데이터로는 쿠버네티스 인프라의 상태 변화를 파악할 수 있고, 적절한 위험 감지 및 조치를 취할 수 있다.

## 6.2 프로메테우스로 모니터링 데이터 수집과 통합하기

프로메테우스는 많은 종류의 오브젝트를 설치한다.

- 프로메테우스 서버(prometheus-server)
    - 공개된 메트릭을 수집해오는 수집기(service discovery 방식)
    - 수집한 시계열 메트릭 데이터를 저장하는 시계열 데이터베이스
    - 저장된 데이터를 질의하거나 수집 대상의 상태를 확인할 수 있는 웹 UI
- 노드 익스포터(node-exporter)
    - 메트릭 정보를 HTTP로 공개
    - 설치된 노드에서 특정 파일들을 읽고, 이를 프로테메우스 서버가 수집할 수 있는 메트릭 데이터로 변환한 후 노드 익스포터 HTTP 서버로 공개함
    - 공개된 내용을 프로메테우스 서버에서 수집해 가게 됨
- 쿠버 스테이트 메트릭(kube-state-metric)
    - API 서버로 쿠버네티스 클러스터의 여러 메트릭 데이터를 수집한 후, 이를 프로메테우스 서버가 수집할 수 있는 메트릭 데이터로 변환해 공개하는 역할을 함
    - 프로메테우스가 쿠버네티스 클러스터의 여러 정보를 손쉽게 획득할 수 있는 것은 모두 쿠버 스테이트 메트릭 덕분임
- 얼럿매니저(alertmanager)
    - 프로메테우스에 alert 규칙을 설정하고, 경보 이벤트가 발생하면 설정된 경보 메시지를 대상에게 전달하는 기능을 제공한다.
    - 프로메테우스에 설치하면 프로메테우스 서버에서 주기적으로 경보를 보낼 대상을 감시해 시스템을 안정적으로 운영할 수 있게 한다.
- 푸시게이트웨이(pushgateway)
    - 배치와 스케줄 작업 시 수행되는 일회성 작업들의 상태를 저장하고 모아서 프로메테우스가 주기적으로 가져갈 수 있도록 공개한다.
    

### 6.2.1 헬름으로 프로메테우스 설치하기

1. 사전 구성 - 헬름, MetalLB
2. 프로메테우스 차트 설치를 위해 프로메테우스 오브젝트 설치(프로메테우스 서버, 노드 익스포터, 쿠버 스테이트 메트릭)
    
    ```bash
    #!/usr/bin/env bash
    helm install prometheus edu/prometheus \ // 프로메테우스 차트를 사용해 프로메테우스 릴리스 설치
    --set pushgateway.enabled=false \ // 푸시게이트웨이 사용하지 않게 설정
    --set alertmanager.enabled=false \ // 얼럿매니저 사용하지 않게 설정
    --set nodeExporter.tolerations[0].key=node-role.kubernetes.io/master \ // 톨러레이션 설정
    --set nodeExporter.tolerations[0].effect=NoSchedule \ // 테인트 설정되 노드 설정 무시
    --set nodeExporter.tolerations[0].operator=Exists \
    --set server.persistentVolume.existingClaim="prometheus-server" \ // "promethus-server" pvc 사용하게 설정
    --set server.securityContext.runAsGroup=1000 \ // 사용자ID, 그룹ID 1000으로 설정
    --set server.securityContext.runAsUser=1000 \
    --set server.service.type="LoadBalancer" \ // MetalLB로부터 외부 IP 할당 받기 위해 로드밸런서로 설정
    --set server.extraFlags[0]="storage.tsdb.no-lockfile" // 프로메테우스 설정 변경 시 lockfile로 에러 날 수 있으니 생성되지 않게 설정
    ```
    
3. 확인
    
    ```bash
    kubectl get pods --selector=app=prometheus
    
    kubectl get service prometheus-server
    ```
    

### 6.2.2 프로메테우스의 웹 UI 다루기

1. 그래프(Graph)
    1. 쿼리 입력기: 표현식(Expression)을 입력해 프로메테우스가 적재한 메트릭 데이터 조회 가능. 이 때 사용하는 표현식은 PromQL이라는 프로메테우스에서 제공하는 쿼리 언어다.
    2. Execute: 쿼리 입력기에 입력한 PromQL을 실행하는 버튼.
    3. Graph: PromQL로 프로메테우스가 적재한 메트릭 데이터를 확인할 때 시각적으로 표현해주는 옵션.
    4. Console: 추출된 데이터를 보여주는 기본 옵션
    5. Add Graph: 쿼리 입력기를 추가함
    6. Remove Graph: 현재 쿼리 입력기 제거.
2. Alert : 서버에 등록된 경보 규칙과 경보 발생 여부를 확인할 수 있다.
3. Status 
    1. Runtime & Build Information : 프로메테우스 서버의 업타임 같은 런타임 관련 정보, 버전을 나타내는 빌드 정보 등 여러 정보를 확인할 수 있다.
    2. Command-Line Flags : 프로메테우스 서버가 실행될 때 인자로 입력 받았던 값을 보여 준다.
    3. Configuration : 프로메테우스 서버가 구동될 때 설정된 값을 표시함.
    4. Rules : 서버에 등록된 다양한 규칙 확인 가능.
    5. Targets : 프로메테우스 서버가 수집해오는 대상의 상태 확인.
    6. Service Discovery : 프로메테우스 서버가 서비스 디스커버리 방식으로 수집한 대상들에 대한 정보를 요약해 보여줌.